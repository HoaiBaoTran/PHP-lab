<!DOCTYPE html>
<html lang="en">

<head>
    <title>Student Management</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>

<body>

    <style>
        .alert {
            max-width: 500px;
            margin: auto;
        }
    </style>

    <script>
        $(document).ready(function () {
            $.get("http://localhost/get-students.php", function (data, status) {
                const studentList = data.data
                studentList.map(student => {
                    const tr =
                        `
                        <tr>
                            <td>${student.id}</td>
                            <td>${student.name}</td>
                            <td>${student.email}</td>
                            <td>${student.phone}</td>
                            <td>
                                <a class="btn btn-sm btn-primary" 
                                    data-id="${student.id}"
                                    data-name='${student.name}'
                                    data-email='${student.email}'
                                    data-phone='${student.phone}'
                                    onclick="editStudent(this)">
                                    Edit
                                </a> 
                                <a class="btn btn-sm btn-danger"
                                    data-id="${student.id}"
                                    data-name='${student.name}'
                                    onclick="confirmRemoval(this)">Delete</a>
                            </td>
                        </tr>
                        `
                    $('#table-body').append(tr)
                })

            }, "json");

            $(".add-student").click(function () {
                const name = $('#name').val()
                const email = $('#email').val()
                const phone = $('#phone').val()
                const student = {
                    name,
                    email,
                    phone
                }
                $.post('http://localhost/add-student.php', student, function (data, status) {
                    const { status: isSuccess, data: message } = data
                    if (!isSuccess) {
                        showErrorMessage(message)
                        return
                    }
                    showSuccessMessage(message)
                    location.reload();
                }, "json")
            });
        });


        // hiện dialog xác nhận khi xóa
        function confirmRemoval(element) {
            const id = element.getAttribute('data-id')
            const name = element.getAttribute('data-name')
            document.getElementById("producer-name").innerHTML = name
            $('#student-id').attr('data-id', id)
            $('#confirm-removal-modal').modal({ show: true });
        }

        function showErrorMessage(errorMessage) {
            document.getElementById("error-message").innerHTML = errorMessage
            $('#error-modal').removeClass('d-none')
            const timeOut = setTimeout(() => {
                $('#error-modal').addClass('d-none')
            }, 5000)
        }

        function showSuccessMessage(successMessage) {
            document.getElementById("success-message").innerHTML = successMessage
            $('#success-modal').removeClass('d-none')
            const timeOut = setTimeout(() => {
                $('#success-modal').addClass('d-none')
            }, 5000)
        }

        const editStudent = (element) => {
            const id = element.getAttribute('data-id')
            const name = element.getAttribute('data-name')
            const email = element.getAttribute('data-email')
            const phone = element.getAttribute('data-phone')
            $('#name').val(name)
            $('#email').val(email)
            $('#phone').val(phone)

            $(".add-student").attr('disabled', true)
            $(".update-student").attr('disabled', false)

            $('.update-student').click(function () {
                const name = $('#name').val()
                const email = $('#email').val()
                const phone = $('#phone').val()
                const student = {
                    id,
                    name,
                    email,
                    phone
                }

                $('#name').val()
                $('#email').val()
                $('#phone').val()


                $.post('http://localhost/update-student.php', student, function (data, status) {
                    const { status: isSuccess, data: message } = data
                    $(".add-student").attr('disabled', false)
                    $(".update-student").attr('disabled', true)
                    location.reload();
                    if (!isSuccess) {
                        showErrorMessage(message)
                        location.reload();
                        return
                    }
                    showSuccessMessage(message)
                    location.reload();

                }, "json")
            })
        }

        const deleteStudent = () => {
            const studentId = $('#student-id').attr('data-id')
            $.post('http://localhost/delete-student.php', { id: studentId }, function (data, status) {
                const { status: isSuccess, data: message } = data
                if (!isSuccess) {
                    showErrorMessage(message)
                    return
                }
                showSuccessMessage(message)
            }, "json")
        }
    </script>

    <div class="container">
        <h3 class="text-primary mt-3">Student Management using Ajax</h1>
            <p>Khi trang web vừa được tải, cần gửi một request đến server, nhận về danh sách sinh viên đang có & hiện
                lên bảng.</p>
            <p>Nhấn <b>Add</b> để thêm một sinh viên vào danh sách: trước hết thông tin sẽ gửi lên server và lưu vào
                database, server sẽ trả về kết quả. Nếu kết quả là <b>true</b> thì đưa thông tin sinh viên vừa thêm vào
                bảng. Nếu lỗi hoặc thành công thì hiện thông báo tương ứng như phía dưới rồi tự ẩn đi sau 5 giây.</p>
            <p>Khi nhấn <b>Edit</b> thông tin sẽ được chuyển qua form để sửa, lúc này disable nút <b>Add</b> và enable
                nút <b>Update</b>, quá trình update cũng tương tự như thêm, gửi thông tin lên server, nhận kết quả rồi
                cập nhật bảng/hiển thị thông báo tương ứng.</p>
            <p>Khi nhấn <b>Delete</b> thì hiện dialog xác nhận trước rồi gửi lệnh xóa lên server, lúc nhận kết quả về
                làm tương tự các bước trước.</p>
            <div class="row">
                <div class="col-md-3">
                    <form class="form-horizontal w-100">
                        <div class="form-group">
                            <label class="control-label col-sm-2" for="name">Name:</label>
                            <input type="text" class="form-control" id="name" placeholder="Enter name">
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-2" for="email">Email:</label>
                            <input type="email" class="form-control" id="email" placeholder="Enter email">
                        </div>
                        <div class="form-group">
                            <label class="control-label col-sm-2" for="phone">Phone:</label>
                            <input type="text" class="form-control" id="phone" placeholder="Enter phone">
                        </div>

                        <div class="form-group">
                            <button type="button" class="btn btn-success add-student">Add</button>
                            <button type="button" class="btn btn-warning update-student disabled">Update</button>
                        </div>
                    </form>


                </div> <!-- Col 1 -->
                <div class="col-md-9 mt-2">
                    <table class="table table-hover mt-4">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <!-- <tr>
                                <td>1</td>
                                <td>Lam Truong</td>
                                <td>john@example.com</td>
                                <td>01234567789</td>
                                <td>
                                    <a class="btn btn-sm btn-primary" href="#">Edit</a> <a class="btn btn-sm btn-danger"
                                        href="#" onclick="confirmRemoval()">Delete</a>
                                </td>
                            </tr>
                            <tr>
                                <td>2</td>
                                <td>Cam Ly</td>
                                <td>john@example.com</td>
                                <td>01234567789</td>
                                <td>
                                    <a class="btn btn-sm btn-primary" href="#">Edit</a> <a class="btn btn-sm btn-danger"
                                        href="#" onclick="confirmRemoval()">Delete</a>
                                </td>
                            </tr>
                            <tr>
                                <td>3</td>
                                <td>My Tam</td>
                                <td>john@example.com</td>
                                <td>01234567789</td>
                                <td>
                                    <a class="btn btn-sm btn-primary" href="#" onclick="showFailedDialog()">Edit</a> <a
                                        class="btn btn-sm btn-danger" href="#" onclick="confirmRemoval()">Delete</a>
                                </td>
                            </tr> -->

                        </tbody>
                    </table>


                </div> <!-- col 2-->
            </div>


            <br><br>
            <div class="alert alert-success alert-dismissable d-none" id="success-modal">
                <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                <strong>Success!</strong>
                <span id="success-message"></span>
            </div>
            <br>
            <div class="alert alert-danger alert-dismissable d-none" id="error-modal">
                <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                <strong>Failed!</strong>
                <span id="error-message"></span>
            </div>

    </div>


    <!-- Confirm Removal Modal -->
    <div id="confirm-removal-modal" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Xóa sinh viên</h4>
                </div>
                <div class="modal-body">
                    <p>Bạn có chắc chắn muốn xóa sinh viên <strong id="producer-name">My Tam</strong>?</p>
                </div>
                <div class="modal-footer">
                    <button onclick="deleteStudent(this)" type="button" id="delete-button" class="btn btn-danger"
                        data-dismiss="modal">Xóa</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Không</button>
                </div>
                <p id="student-id" style="display: none;"></p>
            </div>

        </div>
    </div><!-- Confirm Removel modal -->


</body>

</html>